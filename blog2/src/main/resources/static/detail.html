<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í—¤ì—„í—¤ì—„</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poor+Story&display=swap" rel="stylesheet">

<style>

    *{
        font-family: 'Poor Story', cursive;
    }

    .edit {
        display: none;
        pardding-left: 23px;
    }

    .wrap {
        width: 538px;
        margin: 10px auto;
    }

    .background-header {
        position: fixed;
        z-index: -1;
        top: 0px;
        width: 100%;
        height: 100%;
        background-color: #0a6ecd ;
    }

    .backcolor{
        background-color: #0a6ecd;
    }

    .header {
        margin-top: 50px;
    }

    .header h2 {
        margin-top: 60px;
        height: 33px;
        font-size: 40px;
        font-weight: 500;
        font-stretch: normal;
        font-style: normal;
        line-height: 0.79;
        letter-spacing: -0.5px;
        text-align: center;
        color: #ffffff;
    }

    .header p {
        margin: 40px auto;
        width: 400px;
        height: 48px;
        font-family: 'Noto Sans KR', sans-serif;
        font-size: 16px;
        font-weight: 500;
        font-stretch: normal;
        font-style: normal;
        line-height: 1.5;
        letter-spacing: -1.12px;
        text-align: center;
        color: #ffffff;
    }

    textarea.field {
        width: 502px;
        font-family: 'Noto Sans KR', sans-serif;
        height: 30px;
        border-radius: 5px;
        background-color: #ffffff;
        border: none;
        padding: 18px;
        resize: none;
    }


    textarea.field::placeholder {
        width: 216px;
        height: 16px;
        font-family: 'Noto Sans KR', sans-serif;
        font-size: 16px;
        font-weight: normal;
        font-stretch: normal;
        font-style: normal;
        line-height: 1;
        letter-spacing: -0.96px;
        text-align: left;
        color: #868e96;
    }


    .area-write img{
        cursor: pointer;
        position: relative;
        width: 22.2px;
        height: 18.7px;
        bottom: 50px;
        left: 500px;
    }


    .card {

        border-radius: 5px;
        background-color: #ffffff;
        margin-bottom: 150px;
        padding-bottom: 20px;
    }

    .comment-card{

        border-radius: 5px;
        background-color: #ffffff;
        margin-bottom: 150px;
        padding-bottom: 20px;
    }

    .card .metadata {
        margin-top: 10px;
        position: relative;
        display: flex;
        font-size: 15px;
        font-weight: bold;
        font-stretch: normal;
        font-style: normal;
        line-height: 1;
        letter-spacing: -0.77px;
        text-align: left;
        color: #adb5bd;
        height: 14px;
        padding: 10px 23px;
    }

    .card .metadata .date {

    }

    .card .metadata .name {
        margin-left: 20px;
        margin-right: 5px;
    }

    .comment-metadata{
        margin-left: 20px;
    }

    .title{
        margin-left: 20px;
    }

    .content{
        padding: 0px 23px;
        word-wrap: break-word;
        word-break: break-all;
        margin-left: 30px;
    }

    .comment-content{
        padding: 0px 23px;
        word-wrap: break-word;
        word-break: break-all;
        margin-top: 8px;
    }

    .content div.edit {
        display: none;
    }


    .footer {
        height: 40px;
        top: 15px;
        position: relative;

    }

    .footer img.icon-start-edit {
        cursor: pointer;
        position: absolute;
        bottom: 14px;
        right: 55px;
        width: 18px;
        height: 18px;
    }
    .footer img.icon-delete {
        cursor: pointer;
        position: absolute;
        bottom: 14px;
        right: 19px;
        width: 14px;
        height: 18px;
    }

    .footer img.icon-end-edit {
        cursor: pointer;
        position: absolute;
        display: none;
        bottom: 14px;
        right: 55px;
        width: 20px;
        height: 15px;
    }


    #cards-box {
        margin-top: 100px;
    }

    .card h2 {
        margin-left: 30px;
    }

    a {
        text-decoration: none;
        color: #000000;
    }

    .hide {
        display: none;
    }

    #home{
        text-decoration: none;
        color: #ffffff;
        display: inline;
        text-align: left;
        font-size: 30px;
    }

    #login-text, #signup-text, #logout-text{
        text-decoration: none;
        color: #ffffff;
        display: inline;
        text-align: left;
        font-size: 15px;
    }




</style>

<script th:inline="javascript">

    $(document).ready(function () {
        getPosts();
        getComments();
    })


    function getPosts() {
        $('#cards-box').empty();
        $('#comment-box').empty();
        let detail_id = location.href.split("id=")[1];
        $.ajax({
            type: 'GET',
            url: `/api/hjblog/${detail_id}`,
            date: {},
            success: function (response) {
                let blog = response;
                let id = blog.id;
                let name = blog.name;
                let title = blog.title;
                let content = blog.content;
                let modifiedAt = blog.modifiedAt;
                addHTML(id, name, title, content, modifiedAt )
            }
        })
    }

    function addHTML(id, name, title, content, modifiedAt) {
        let temp_html = makePost(id, name, title, content, modifiedAt)
        $('#cards-box').append(temp_html);
        }

        function makePost (id, name, title, content, modifiedAt)    {
            let loginname = [[$name]];
            let hide = ""
            if(loginname != name){
                hide = "hide"
            }
            return `<div class="card">
                        <div class="metadata">
                           <div id="${id}-name" class="name">
                               ${name}
                           </div>
                           <div class="date">
                               ${modifiedAt}
                           </div>
                        </div>
                    <h2 class='title' id="${id}-title">"${title}"</h2>

                        <div class="content" id="${id}-content">
                           ${content}
                        </div>
                        <div class="footer" ${hide}>
                            <img id="${id}-delete" class="icon-delete" src="images/delete.png" alt="" onclick="delPost('${id}')">
                        </div>
                    </div>`;
        }


        function delPost(id) {
            if (confirm("ì •ë§ íƒœìš°ì‹œê²Œìš”?") == true) {
                $.ajax({
                    type: "DELETE",
                    url: `/api/hjblog/${id}`,
                    success: function (response) {
                        alert('ì¿ë”ë¯¸ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        location.href = 'index.html';
                    }
                })
            }
        }

//        ëŒ“ê¸€
        function getComments(){
        let contentId = location.href.split("id=")[1];
        $.ajax({
            type: "GET",
            url: `/api/comment/${contentId}`,
            data: {},
            success: function (response) {
                for (let i = 0; i < response.length; i++) {
                    let blog = response[i];
                    let id = blog.id;
                    let name = blog.name;
                    let comment = blog.comment;
                    let modifiedAt = blog.modifiedAt;
                    addCommentHTML(id, name, comment, modifiedAt);
                }
            }
        });
        }

        //ëŒ“ê¸€ ë¶™ì´ê¸°
    function addCommentHTML(id, name, comment, modifiedAt) {
        let tempHtml = makeComment(id, name, comment, modifiedAt);
        $('#comment-box').append(tempHtml);
    }

    // ëŒ“ê¸€ì˜ í˜•íƒœë¥¼ ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤.
    function makeComment(id, name, comment, modifiedAt) {
        let loginname = [[${name}]];
        console.log(loginname)
        let hide = "hide"
        if (loginname == name) {
            hide = ""
        }
        return `<div class="card">
                        <div class="metadata">
                           <div id="${id}-name" class="name">
                               ${name}
                           </div>
                           <div class="date">
                               ${modifiedAt}
                           </div>
                        </div>
                        <div class="content" id="${id}-comment" >
                           ${comment}
                        </div>
                        <div id="${id}-editarea" class="edit">
                            <textarea id="${id}-textarea" class="te-edit" name="" id="" cols="30" rows="5"></textarea>
                        </div>
                            <div class="footer ${hide}">
                                <img id="${id}-edit" class="icon-start-edit" src="images/edit.png" alt="" onClick="editPost('${id}')">
                                <img id="${id}-delete" class="icon-delete" src="images/delete.png" alt="" onClick="delPost('${id}')">
                                <img id="${id}-submit" class="icon-end-edit" src="images/done.png" alt="" onClick="submitEdit('${id}')">
                            </div>
                    </div>`;
    }

    // ìˆ˜ì • ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ, ê¸°ì¡´ ì‘ì„± ë‚´ìš©ì„ ìˆ˜ì •ë°•ìŠ¤(textarea)ì— ì „ë‹¬í•©ë‹ˆë‹¤.
    function editPost(id) {
        showEdits(id);
        let content = $(`#${id}-comment`).text().trim();
        $(`#${id}-textarea`).val(content);
    }

    // ìˆ¨ê¸¸ ë²„íŠ¼ì„ ìˆ¨ê¸°ê³ , ë‚˜íƒ€ë‚¼ ë²„íŠ¼ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
    function showEdits(id) {
        $(`#${id}-editarea`).show();
        $(`#${id}-submit`).show();
        $(`#${id}-delete`).show();

        $(`#${id}-comment`).hide();
        $(`#${id}-edit`).hide();
    }

    // ìˆ˜ì •ëœ ëŒ“ê¸€ì„ put ìš”ì²­ ë³´ë‚´ update í•©ë‹ˆë‹¤.
    function submitEdit(id) {
        // 1. ì‘ì„± ëŒ€ìƒ ë©”ëª¨ contents ë¥¼ í™•ì¸í•©ë‹ˆë‹¤
        let comment = $(`#${id}-textarea`).val().trim();
        // 2. ì‘ì„±í•œ ë©”ëª¨ê°€ ì˜¬ë°”ë¥¸ì§€ isValidContents í•¨ìˆ˜ë¥¼ í†µí•´ í™•ì¸í•©ë‹ˆë‹¤.
        if (isValidContent(comment) == false) {
            return;
        }
        // 3. ì „ë‹¬í•  data JSONìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
        let data = {"comment": comment};
        // 4. PUT /api/memos/{id} ì— dataë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
        $.ajax({
            type: "PUT",
            url: `/api/comment/${id}`,
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (response) {
                alert('ë©”ì‹œì§€ ë³€ê²½ì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤.');
                window.location.reload();
            }
        });
    }

    // ê¸€ì´ ì •ìƒì¸ì§€ í™•ì¸
    function isValidContent(content) {
        if (content == '') {
            alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return false;
        }
        return true;
    }

    // ëŒ“ê¸€ì„ ì‘ì„±í•˜ê³  post ìš”ì²­ì„ ë³´ë‚´ ì €ì¥í•©ë‹ˆë‹¤.
    function writeComment() {
        let contentId = location.href.split("id=")[1];
        var name = [[${name}]];
        let comment = $('#comment').val();
        if (isValidContent(comment) == false) {
            return;
        }

        let data = {'contentId': contentId, 'name': name, 'comment': comment};
        $.ajax({
            type: "POST",
            url: "/api/comment",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (response) {
                if (response == true) {
                    alert('ë©”ì‹œì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.reload();
                } else {
                    alert('ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”');
                    window.location.replace("/user/login");
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert('ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”');
                window.location.replace("/user/login");
            }
        });
    }

    // ëŒ“ê¸€ì˜ id ê°’ì„ ë°›ì•„ í•´ë‹¹ ëŒ“ê¸€ì„ ì‚­ì œí•©ë‹ˆë‹¤.
    function deleteComment(id) {
        if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ??") == false) {
            return
        }
        $.ajax({
            type: "DELETE",
            url: `/api/comment/${id}`,
            success: function (response) {
                alert('ëŒ“ê¸€ ì‚­ì œì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤.');
                window.location.reload();
            }
        })
    }

</script>
</head>
<body class="backcolor">
<div class="background-header">

</div>

<div class="wrap">
    <div class="header">
        <a href="/" id="home">Home  | </a>
        <a sec:authorize="!isAuthenticated()" id="login-text" href="/user/login">
            ë¡œê·¸ì¸
        </a>
        <a sec:authorize="!isAuthenticated()" id="signup-text" href="/user/signup">
            íšŒì›ê°€ì…
        </a>
        <a sec:authorize="isAuthenticated()" id="logout-text" href="/user/logout">
            ë¡œê·¸ì•„ì›ƒ
        </a>

        <h2>XXì›” XXì¼.  ì˜¤ëŠ˜ë„ ë¬´ì‚¬íˆ ğŸ‹</h2>
        <p>
            ì´ ì‹œê°„ë“¤ì´ ìŒ“ì´ë©´ ë©‹ì§„ ì„¬ì— ê¹ƒë°œ ê½‚ê²Œ ë  ë‚ ì´ ì˜¬ê±°ì•¼!
        </p>
    </div>

<div id="cards-box" class="area-read">
    <div class="card">
        <!-- date/name ì˜ì—­ -->
        <div class="metadata">
            <div class="date">
                January 24, 2022
            </div>
            <div class="name">
                sundayã…ã…ˆ
            </div>
        </div>
        <h2 class='title' id="${id}-title">ì¼ìš”ì¼</h2>
        <div class="content">
            <div id="1-content" class="text">
                ì•„ì§ë„ í•  ê²Œ í•œì°¸ ë‚¨ì•˜ë‹¤..
        </div>
            <div id="1-editarea" class="edit">
            </div>
        <!-- ë²„íŠ¼ ì˜ì—­-->
        <div class="footer">
            <img id="1-edit" class="icon-start-edit" src="images/edit.png" alt="" onclick="editPost('1')">
            <img id="1-delete" class="icon-delete" src="images/delete.png" alt="" onclick="deleteComment('1')">
            <img id="1-submit" class="icon-end-edit" src="images/done.png" alt="" onclick="submitEdit('1')">
        </div>
    </div>
    </div>
<div class="area-write">
        <textarea class="field" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" name="comment" id="comment" cols="30"
                  rows="3"></textarea>
    <img src="images/send.png" alt="" onclick="writeComment()">
</div>
<div id="comment-box" class="area-read">
    <div class="comment-card">
        <div class="comment-metadata">
            <div id="${id}-name" class="name">
                ${name}
                ${modifiedAt}
            </div>
        </div>
        <div class="comment-content" id="${id}-content">
            ${content}
        </div>
        </a>
        <div class="footer">
            <img id="${id}-edit" class="icon-start-edit" src="images/edit.png" alt="" onclick="editPost('${id}')">
            <img id="${id}-delete" class="icon-delete" src="images/delete.png" alt="" onclick="delPost('${id}')">
        </div>
    </div>
</div>
</div>
</div>
</body>
</html>